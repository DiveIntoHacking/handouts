## シーケンス図

```plantuml
@startuml

actor 太郎
actor 花子
database シグナリングサーバ

== 初期化 ==

太郎 -> STUNサーバ: STUNサーバの設定をする
花子 -> STUNサーバ: 同上

太郎 -> 太郎: メディア(音声とビデオ)の使用を許可する
花子 -> 花子: 同上

太郎 -> 太郎: シグナリングサーバと通信をするための\nインスタンスを作成する
花子 -> 花子: 同上

太郎 -> 太郎: 自分の名前をアプリケーションに登録する
花子 -> 花子: 同上

太郎 -> シグナリングサーバ: シグナリングサーバをリスン(👀)する\nリスンするパスは自分の名前配下とする
花子 -> シグナリングサーバ: 同上

== offerの送受信 ==

太郎 -> 太郎: 相手の名前をアプリケーションに登録する
太郎 -> 太郎: 通信経路をシグナリングサーバに\n送信できるようにイベントハンドラを作成する
太郎 -> 太郎: P2P接続確立後、\n通信相手のメディアストリーム情報の受信後、\n表示先のDOMを登録しておく
太郎 -> 太郎: 太郎のSDPを作成し保存する
太郎 -> シグナリングサーバ: SDP(offer)を送信する。

花子 <- シグナリングサーバ: SDP(offer)を受信する。
花子 -> 花子: 相手の名前をアプリケーションに登録する
花子 -> 花子: 通信経路をシグナリングサーバに\n送信できるようにイベントハンドラを作成する
花子 -> 花子: P2P接続確立後、\n通信相手のメディアストリーム情報の受信後、\n表示先のDOMを登録しておく
花子 -> 花子: 太郎のSDPを保存する

== answerの送受信 ==

花子 -> 花子: 花子のSDPを作成し保存する
花子 -> シグナリングサーバ: SDP(answer)を送信する。
シグナリングサーバ -> 太郎: SDP(answer)を受信する。

太郎 -> 太郎: 花子のSDPを保存

== candidate(通信経路)の送受信を何度か行う ==

STUNサーバ -> 太郎: candidateを取得する。
STUNサーバ -> 花子: candidateを取得する。

太郎 -> シグナリングサーバ: candidateを転送する。
花子 <- シグナリングサーバ: candidateを転送する。
花子 <- 花子: 受信したcandidateを登録する。

花子 -> シグナリングサーバ: candidateを送信する。
太郎 <- シグナリングサーバ: candidateを受信する。
太郎 <- 太郎: 受信したcandidateを登録する。


note over 太郎, 花子
P2P接続確立
end note


太郎 <-> 花子: 音声とビデオの送受信
activate 太郎
activate 花子
太郎 <-> 花子: :
太郎 <-> 花子: :

@enduml
```

<!--
| 注釈番号 | 説明 |
| -------- |---- |
|0|STUNサーバの設定を用いてRTCPeerConnection のインスタンスを作成する。<br />STUNサーバとは外部の端末から接続できるようにするためのグローバルIP及びポート情報を通知してくれるサーバのこと。|
| 1 | メディアとはオーディオとビデオのこと。 <br /> MediaStream というオブジェクトが得られる。   |
| 3        | P2P 通信をする花子がシグナリングサーバにデータを書き込んだ時にイベントが発生する。そのイベントを契機に、書き込まれたデータをリアルタイムに取得するための仕掛けを行っておく。 |
| 5-1        | ここで言うイベントとは、シグナリングサーバ上のデータの書き込みのこと。<br />通信花子からデータの書き込みがあった時にリアルタイムにそれを読み取り、適切なアクションを取る必要がある。まだその書き込みが開始される前となるこのフェーズで、データの読み取りができるように準備を行う。<br /> 尚、ここで書き込まれるデータのタイプには、`offer`、`answer`、`candidate`の 3 つがある。  <br />ここでは、`太郎`配下の領域に対する書き込みを拾うように設定する。|
| 5-2        | 5-1とほぼ同様のことをする。<br />唯一違うのは、`花子`配下の領域に対する書き込みを拾うように設定する点のみである。|
|6|candidateをシグナリングサーバに送信できるようにイベントハンドラを作成する|
|7|P2P通信確立後に通信花子からメディアストリーム情報を受け取ったら[`HTMLMediaElement.srcObject`](https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/srcObject)に設定できるようにイベントハンドラを作成する|
|8|太郎が使用可能なコーデック情報等(SDP)を花子がリスンしているサーバに送信する。|
|9|花子が使用可能なコーデック情報等(SDP)を花子がリスンしているサーバに送信する。|
prettier-ignore -->
